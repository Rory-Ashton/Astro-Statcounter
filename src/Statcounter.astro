---
interface Props {
  sc_project: number;
  sc_security: string;
  sc_manageConsent?: boolean;
  sc_CMP?: 'cookieyes' | 'vanillaJOP' | 'cookiebot';
}

declare global {
  interface Window {
    sc_project?: number;
    sc_security?: string;
    sc_invisible?: number;
    sc_https?: number;
    __sc_last_url?: string;
    __sc_consent_listening?: boolean;
  }
}

const {
  sc_project,
  sc_security,
  sc_manageConsent = false,
  sc_CMP
} = Astro.props;
---

<script is:inline define:vars={{ sc_project, sc_security, sc_manageConsent, sc_CMP}}>
(function () {
  // const sc_CMP = 'cookiebot'; // 'vanillaJOP' | 'cookieyes' | 'cookiebot'
  console.log(sc_CMP);
  const SIMPLE_MODE = !sc_manageConsent;

  let consentState = SIMPLE_MODE ? 'granted' : 'unknown';
  let lastUrl;

  function onConsentChange(allowed) {
    consentState = allowed ? 'granted' : 'denied';
    if (allowed) track();
  }

  // ---- sc_CMP wiring (input only, no side effects) ----

  if (sc_manageConsent) {

    if (sc_CMP === 'vanillaJOP') {
      const handler = (e) => {
        const categories =
          e.detail?.cookie?.categories ??
          e.detail?.categories ??
          [];
        onConsentChange(categories.includes('analytics'));
      };

      window.addEventListener('cc:onChange', handler);
      window.addEventListener('cc:onConsent', handler);
    }

    if (sc_CMP === 'cookieyes') {
      const handler = () => {
        if (typeof window.getCkyConsent !== 'function') return;
        const consent = window.getCkyConsent();
        onConsentChange(consent?.categories?.analytics === true);
      };

      document.addEventListener('cookieyes_consent_update', handler);
      document.addEventListener('cookieyes_banner_load', handler);
    }

     if (sc_CMP === 'cookiebot') {
      // Consent ready > read Cookiebot.consent
      window.addEventListener('CookiebotOnConsentReady', () => {
        const stats = window.Cookiebot?.consent?.statistics === true;
        onConsentChange(stats);
      });

      // Respond to explicit accept/decline
      window.addEventListener('CookiebotOnAccept', () => {
        const stats = window.Cookiebot?.consent?.statistics === true;
        onConsentChange(stats);
      });

      window.addEventListener('CookiebotOnDecline', () => {
        onConsentChange(false);
      });
    }
  }

  // ---- Tracking (single authority) ----

  function track() {
    if (consentState !== 'granted') return;
    const url = location.href;
    if (lastUrl === url) return;
    lastUrl = url;

    if (window._statcounter) {
      _statcounter.record_pageview();
      return;
    }

    Object.assign(window, {
      sc_project,
      sc_security,
      sc_invisible: 1,
      sc_https: 1,
    });

    // dont re-add counter.js script if it exist
    if (document.getElementById('statcounter-script')) return;

    // dont add counter.js if the statcounter variables arent okay
    if (!sc_project || !sc_security) {
      console.warn("Statcounter missing variables.  Ensure `var sc_project` and `var sc_security` are both set with your project details.  The plugin will not run without them both in place.");
      return;
    }

    const s = document.createElement('script');
    s.id = "statcounter-script";
    s.async = true;
    s.src = 'https://www.statcounter.com/counter/counter.js';
    document.head.appendChild(s);
  }

  document.addEventListener('astro:page-load', track);
  track();

  if (SIMPLE_MODE) track();
})();

</script>