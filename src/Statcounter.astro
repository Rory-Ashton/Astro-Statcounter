---
interface Props {
  sc_project: number;
  sc_security: string;
  manageConsent?: boolean;
  cmp?: 'cookieyes' | 'cookiebot';
}

declare global {
  interface Window {
    sc_project?: number;
    sc_security?: string;
    sc_invisible?: number;
    sc_https?: number;
    __sc_last_url?: string;
    __sc_consent_listening?: boolean;
  }
}

const {
  sc_project, 
  sc_security,
  manageConsent = false,
} = Astro.props;
---

<script is:inline define:vars={{ sc_project, sc_security, manageConsent}}>
(function() {

    var CMP = 'cookieyes'; // cookieyes | cookiebot | auto (future)

    const LOG_PREFIX = 'plugin >>';

    const CookieYesAdapter = {
      setup(changeAction) {
        const handler = () => {
            changeAction('handler');
        };

        // CookieYes events do not bubble to window , only document
        document.addEventListener('cookieyes_consent_update', handler);
        document.addEventListener('cookieyes_banner_load', handler);
      },

      getAnalyticsConsent(caller) {
          console.log(caller)
        if (typeof window.getCkyConsent !== 'function') {
          console.warn('[CookieYesAdapter] getCkyConsent() not available yet');
          return false;
        }
        const consent = window.getCkyConsent();
        console.log('[CookieYesAdapter] getCkyConsent ready : ', consent);

        return consent?.categories?.analytics === true;
      }
    };


const CMP_ADAPTERS = {
  cookieyes: CookieYesAdapter,
  // cookiebot: CookiebotAdapter, (later)
};

  let isTrackingAuthorized = false;

  if (manageConsent === true) {
    isTrackingAuthorized = false;
    const adapter = CMP_ADAPTERS[CMP];

     if (!adapter) {
         console.warn('[Statcounter] !adapter > Unsupported CMP :', CMP);
     } else {
         adapter.setup(syncConsent);
     }
  } else {
    isTrackingAuthorized = true;
  }

  console.log(LOG_PREFIX, 'Initial isTrackingAuthorized state:', isTrackingAuthorized);

  const track = () => {

    if (isTrackingAuthorized === false) return;

    const currentUrl = window.location.href;
    if (window.__sc_last_url === currentUrl) return; // Prevent duplicates

    console.log(LOG_PREFIX, 'Firing Hit for:', currentUrl);
    window.__sc_last_url = currentUrl;

    // If counter.js is already loaded just fire a pageview event
    if (window._statcounter && typeof window._statcounter == 'function') {
      if (window.sc_project && window.sc_security) {
        _statcounter.record_pageview();
      }
      return;
    }

    window.sc_project = sc_project;
    window.sc_security = sc_security;
    window.sc_invisible = 1;
    window.sc_https = 1;

    const oldScript = document.getElementById('statcounter-script');
    if (oldScript) oldScript.remove();

    const script = document.createElement('script');
    script.id = 'statcounter-script';
    script.async = true;
    script.src = "https://www.statcounter.com/counter/counter.js";
    if (window.sc_project && window.sc_security) {
      document.head.appendChild(script);
    }
  };

function syncConsent(caller) {
    console.log('syncConsent caller : ', caller)
  const allowed = adapter.getAnalyticsConsent();

  console.log('[Statcounter] syncConsent() :', allowed);

  if (allowed) {
      console.log(LOG_PREFIX, 'if (allowed) true');
      isTrackingAuthorized = true;
    track();
  } else {
      console.log(LOG_PREFIX, 'if (allowed) else > disableAnalytics()');
      isTrackingAuthorized = false;
  }
}


  // Listen for SPA Navigation
  document.addEventListener('astro:page-load', () => {
    console.log(LOG_PREFIX, 'astro:page-load triggered');
    
    if (isTrackingAuthorized) {
      console.log(LOG_PREFIX, 'astro:page-load > isTrackingAuthorized');
      track();
    } else {
      console.log(LOG_PREFIX, 'astro:page-load > SPA : isTrackingAuthorized else false.  manageConsent : false');
    }
  });

  // 3. Initial execution for "Simple Mode"
  if (!manageConsent) {
    console.log(LOG_PREFIX, '(!manageConsent) > Simple Mode: Firing initial track()');
    track();
  }

})();
</script>