---
const {
  sc_project,
  sc_security,
  sc_manageConsent = false,
  sc_CMP
} = Astro.props;
---

<script is:inline define:vars={{ sc_project, sc_security, sc_manageConsent, sc_CMP}}>
(function () {

  let lastUrl;
  function onConsentChange(allowed) {
    consentState = allowed ? 'granted' : 'denied';
    if (allowed) track();
  }

  // ---- start CMP manageConsent ----

  if (sc_manageConsent) {
    const cmp =
      typeof sc_CMP === 'string'
        ? sc_CMP.toLowerCase()
        : null;

    const VALID_CMPS = ["vanillajop", "cookieyes", "cookiebot"];

    if (typeof cmp !== "string") {
      console.warn(`[Statcounter] manageConsent is enabled but CMP is missing. Valid values: ${VALID_CMPS.join(", ")}`);
    } else if (!VALID_CMPS.includes(cmp)) {
      console.warn(`[Statcounter] manageConsent is enabled but CMP "${cmp}" is not recognized. Valid values: ${VALID_CMPS.join(", ")}`);
    }

     if (cmp === 'vanillajop') {
      const handler = (e) => {
        const categories =
          e.detail?.cookie?.categories ??
          e.detail?.categories ??
          [];
        onConsentChange(categories.includes('analytics'));
      };

      // cc:onChange fires on every pageload, everytime
      // this is effectively checks the consent state
      // even if was set previously
      if (!window.__sc_consent_listening_vanillajop) {
        window.__sc_consent_listening_vanillajop = true;
        window.addEventListener('cc:onChange', handler);
        window.addEventListener('cc:onConsent', handler);
      }
    }
    
    // CMP lifecycle events fire even when consent already exists
    if (cmp === 'cookieyes') {
      const handler = () => {
        if (typeof window.getCkyConsent !== 'function') return;
        const consent = window.getCkyConsent();
        onConsentChange(consent?.categories?.analytics === true);
      };
      if (!window.__sc_consent_listening_cookieyes) {
        // Read current state for CookieYes in case the event happened already
        handler();
        window.__sc_consent_listening_cookieyes = true;
        document.addEventListener('cookieyes_consent_update', handler);
        document.addEventListener('cookieyes_banner_load', handler);
      }
    }

    // CMP lifecycle events fire even when consent already exists
    if (cmp === "cookiebot") {
      const read = () => {
        const stats = window.Cookiebot?.consent?.statistics === true;
        onConsentChange(stats);
    };

      if (!window.__sc_consent_listening_cookiebot) {
        window.__sc_consent_listening_cookiebot = true;

        // If Cookiebot is already present, read "after the fact" immediately
        if (window.Cookiebot?.consent) read();

        // Otherwise, wait for consent-ready (covers "loaded from existing cookie")
        window.addEventListener("CookiebotOnConsentReady", read);

        // Optional: still respond to explicit accept/decline
        window.addEventListener("CookiebotOnAccept", read);
        window.addEventListener("CookiebotOnDecline", () => onConsentChange(false));
      }
    }
  }

  // ---- end CMP manageConsent ----

  // ---- start track ----

  function track() {
    if (consentState !== 'granted') return;
    const url = location.href;
    if (lastUrl === url) return;
    lastUrl = url;

    if (window._statcounter) {
      _statcounter.record_pageview();
      return;
    }

    Object.assign(window, {
      sc_project,
      sc_security,
      sc_invisible: 1,
      sc_https: 1,
    });

    // dont re-add counter.js script if it exist
    if (document.getElementById('statcounter-script')) return;

    // dont add counter.js if the statcounter variables arent okay
    if (!sc_project || !sc_security) {
      console.warn("Statcounter missing variables.  Ensure `var sc_project` and `var sc_security` are both set with your project details.  The plugin will not run without them both in place.");
      return;
    }

    const s = document.createElement('script');
    s.id = "statcounter-script";
    s.async = true;
    s.src = 'https://www.statcounter.com/counter/counter.js';
    document.head.appendChild(s);
  }

  // ---- end track ----

  // ---- fire off pageload ----

  if (!window.__sc_astro_listener_added) {
    document.addEventListener('astro:page-load', track);
    window.__sc_astro_listener_added = true;
  }
  
  track();

})();

</script>